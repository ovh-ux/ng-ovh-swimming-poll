/*! ovh-angular-swimming-poll - 3.0.0 - 2018-08-04 */
angular.module("ovh-angular-swimming-poll",[]),angular.module("ovh-angular-swimming-poll").service("Poller",["$q","$timeout","$http",function(a,b,c){"use strict";function d(a,b){a.retryCountAttempts=0,a.deferredObj.resolve(b),_.remove(n,a)}function e(a,c){a.retryCountAttempts<a.retryMaxAttempts?(a.retryCountAttempts++,b(function(){i(a)},a.retryTimeoutDelay)):(a.deferredObj.reject(c),_.remove(n,a))}function f(a,b){return a.retryCountAttempts=0,a.deferredObj.notify(b),a.lastResult=angular.copy(b),g(a)}function g(a){var c="function"==typeof a.interval?a.interval(m++):a.interval;return a.timeoutPromise=b(function(){i(a)},c),null}function h(a,b){return"function"==typeof a?a(b):_.every(a,function(a,c){return"function"==typeof a?a(b,m):b[c]===a})}function i(a){var b=angular.extend({url:a.url,method:a.method.toLowerCase(),data:a.postData},a.opts);c(b).then(function(b){var c=b.data,g=[];angular.isArray(c)?g=c:g.push(c);var i=0,j=0,k=0;return angular.forEach(g,function(b){if(a.successRule)h(a.successRule,b)?i++:a.errorRule&&h(a.errorRule,b)?j++:k++;else switch(c.status){case"done":case"cancelled":case"DONE":case"CANCELLED":i++;break;case"customerError":case"ovhError":case"error":case"blocked":case"CUSTOMER_ERROR":case"OVH_ERROR":case"ERROR":case"BLOCKED":j++;break;default:a.errorRule&&h(a.errorRule,b)?j++:k++}}),i===g.length?d(a,c):!j||k||a.notifyOnError?f(a,c):e(a,c)},function(b){return 404===b.status&&a.lastResult?d(a,a.lastResult):0!==b.status?e(a,b):b})}var j=7e3,k=3,l=1e4,m=0,n=[];this.poll=function(b,c,d){var e={},f={};c&&(e=c),d&&(f=d),m=0;var g=_.find(n,{url:b,scope:f.scope||null,namespace:f.namespace||null});if(g)return g.deferredObj.promise;var h=a.defer(),o=angular.extend({deferredObj:a.defer(),timeoutDeferredObj:h,url:b,opts:angular.extend(e,{timeout:h.promise}),interval:j,lastResult:null,successRule:null,errorRule:null,scope:null,namespace:null,postData:null,retryMaxAttempts:k,retryCountAttempts:0,retryTimeoutDelay:l,method:"get"},f);return n.push(o),i(o),o.deferredObj.promise},this.kill=function(a){var c=_.filter(n,a);c.length&&(angular.forEach(c,function(a){a.timeoutDeferredObj.resolve(),a.deferredObj.reject({}),b.cancel(a.timeoutPromise)}),_.remove(n,a))}}]);